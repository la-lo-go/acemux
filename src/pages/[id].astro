---
import { Icon } from 'astro-icon/components'
import { getStream } from '../lib/db'
import VideoPlayer from '../lib/components/player/VideoPlayer.astro'
import '../styles.css'

const id = Astro.params.id as string
const stream = getStream(id) 
const title = stream?.name ?? id

if (!stream) {
  return Astro.redirect('/')
}

const aceStreamBase = (import.meta.env.ACESTREAM_BASE || 'http://acestream:6878').replace(/\/+$/, '')
const vlcUrl = `vlc://${aceStreamBase}/ace/manifest.m3u8?id=${encodeURIComponent(id)}`
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{title} Â· AceMux</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¬</text></svg>" />
    <script define:vars={{ aceStreamBase: import.meta.env.ACESTREAM_BASE || 'http://acestream:6878', streamId: id }}>
      window.aceStreamBase = aceStreamBase.replace(/\/+$/, '');
      window.streamId = streamId;
    </script>
  </head>
  <body class="m-0 bg-[#0a0d12] text-[#e6eef7] font-[system-ui,Segoe_UI,Roboto,Arial,sans-serif] leading-[1.4]">
    <div class="max-w-[980px] mx-auto p-3 sm:p-6">
      <a class="text-[#9fb3c8] no-underline hover:text-sky-400 transition-colors text-sm sm:text-base" href="/">&larr; Back</a>
      
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-4 my-2 mb-3 sm:mb-4">
        <h1 class="m-0 text-lg sm:text-[22px] truncate">{title}</h1>
        
        <div class="flex gap-2 flex-shrink-0">
          <button 
            id="copyLinkBtn"
            class="px-3 sm:px-4 py-2 rounded-xl border border-slate-700/40 bg-[#111a24] hover:bg-[#162635] text-sm inline-flex items-center justify-center gap-1.5 transition-colors hover:border-slate-600/40"
            title="Copy AceStream link"
          >
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0">
              <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
              <path d="m4 16c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2"/>
            </svg>
            <span>Copy Link</span>
          </button>
          
          <a 
            class="px-3 sm:px-4 py-2 rounded-xl border border-slate-700/40 bg-[#111a24] hover:bg-[#162635] text-sm inline-flex items-center justify-center gap-1.5 transition-colors hover:border-slate-600/40 no-underline text-[#e6eef7]"
            href={vlcUrl} 
            title="Open in VLC"
          >
            <Icon name="vlc" width="14" height="14" />
            <span>VLC</span>
          </a>
        </div>
      </div>

      <VideoPlayer streamId={id} />
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const copyBtn = document.getElementById('copyLinkBtn');
        
        if (copyBtn) {
          copyBtn.addEventListener('click', async () => {
            const aceStreamUrl = `/ace/manifest.m3u8?id=${encodeURIComponent((window as any).streamId)}`;
            const fullUrl = window.aceStreamBase + aceStreamUrl;
            
            try {
              await navigator.clipboard.writeText(fullUrl);
              showCopyFeedback(copyBtn);
            } catch (err) {
              // Fallback for older browsers
              const textArea = document.createElement('textarea');
              textArea.value = fullUrl;
              document.body.appendChild(textArea);
              textArea.select();
              try {
                document.execCommand('copy');
                showCopyFeedback(copyBtn);
              } catch (fallbackErr) {
                alert(`Copy this link: ${fullUrl}`);
              }
              document.body.removeChild(textArea);
            }
          });
        }
        
        function showCopyFeedback(btn: HTMLElement) {
          const originalContent = btn.innerHTML;
          btn.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 6 9 17l-5-5"/>
            </svg>
            <span>Copied!</span>
          `;
          btn.style.color = '#10b981';
          btn.style.borderColor = '#10b981';
          
          setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.style.color = '';
            btn.style.borderColor = '';
          }, 2000);
        }
      });
    </script>
  </body>
</html>